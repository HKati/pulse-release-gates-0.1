name: Secret Full Sweep
on:
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  sweep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history for TruffleHog

      # A) Working tree gyors grep (tipikus minták)
      - name: Grep common secret patterns (working tree)
        shell: bash
        run: |
          set -euo pipefail
          PATTERN='(BEGIN (RSA|OPENSSH) PRIVATE KEY|Authorization: Bearer|api[_-]?key|apikey|token|password|aws_access_key_id|aws_secret_access_key|ghp_[0-9A-Za-z]{36}|xox[baprs]-[0-9A-Za-z-]+|OPENAI_API_KEY|AZURE_OPENAI_KEY|HF_TOKEN)'
          grep -rInE --exclude-dir=".git" "$PATTERN" . || echo "No obvious secrets found in working tree."

      # B) Teljes git history vizsgálat (TruffleHog)
      - name: Run TruffleHog (git history)
        id: th
        uses: trufflesecurity/trufflehog@v3
        with:
          scan: git
          path: .
        continue-on-error: true   # ne blokkoljon, csak jelezzen

      - name: Save TruffleHog findings
        if: always()
        run: |
          mkdir -p findings
          echo "${{ steps.th.outputs.result }}" > findings/trufflehog.json || true

      - name: Upload findings
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-findings
          path: findings/
