name: EPF experiment (shadow)

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
    paths:
      - "PULSE_safe_pack_v0/**"
      - "tools/**"
      - "scripts/**"
      - "pulse_gates.yaml"
      - ".github/workflows/epf_experiment.yml"

permissions:
  contents: read

jobs:
  ab-run:
    concurrency:
      group: epf-shadow-${{ github.ref }}
      cancel-in-progress: true

    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.11"

      - name: Install deps (PULSE pack if available, else minimal)
        id: deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip

          deps_rc=0
          if [ -f PULSE_safe_pack_v0/requirements.txt ]; then
            echo "Installing PULSE_safe_pack_v0 requirements..."
            set +e
            python -m pip install -r PULSE_safe_pack_v0/requirements.txt
            deps_rc=$?
            set -e
          else
            echo "No PULSE_safe_pack_v0/requirements.txt, installing minimal deps..."
            set +e
            python -m pip install numpy 'jsonschema>=4,<5'
            deps_rc=$?
            set -e
          fi

          echo "rc=$deps_rc" >> "$GITHUB_OUTPUT"
          if [ "$deps_rc" -ne 0 ]; then
            echo "::warning::Dependency install failed (rc=$deps_rc). Continuing in stub/best-effort mode."
          fi

      - name: Prepare inputs from PULSE pack baseline (or stub)
        id: prepare
        shell: bash
        run: |
          set -euo pipefail

          runall_rc=0
          if [ -f PULSE_safe_pack_v0/tools/run_all.py ]; then
            echo "Running PULSE_safe_pack_v0/tools/run_all.py to produce baseline status.json..."
            set +e
            python PULSE_safe_pack_v0/tools/run_all.py
            runall_rc=$?
            set -e

            if [ "$runall_rc" -ne 0 ]; then
              echo "::warning::run_all.py exited non-zero (rc=$runall_rc). Will use stub if status.json is missing."
            fi

            if [ -f PULSE_safe_pack_v0/artifacts/status.json ]; then
              cp PULSE_safe_pack_v0/artifacts/status.json status.json
              echo "Using PULSE_safe_pack_v0/artifacts/status.json as baseline status.json"
            else
              echo "::warning::status.json not found after run_all.py; using stub status.json"
              echo '{"metrics": {}}' > status.json
            fi
          else
            echo "::warning::PULSE_safe_pack_v0/tools/run_all.py not found; using stub status.json"
            echo '{"metrics": {}}' > status.json
          fi

          echo "runall_rc=$runall_rc" >> "$GITHUB_OUTPUT"

      - name: Baseline (deterministic) or stub
        id: base
        shell: bash
        run: |
          set -euo pipefail

          # Start from status.json (real baseline or stub)
          if [ -f status.json ]; then
            cp status.json status_baseline.json
          else
            echo '{"decisions": {}}' > status_baseline.json
          fi

          # If there is no EPF gate config, stay in stub mode
          if [ ! -f pulse_gates.yaml ]; then
            echo "::warning::pulse_gates.yaml not found; baseline gate evaluation will run in stub mode."
            echo "rc=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          rc=0
          if [ -f tools/check_gates.py ]; then
            echo "Running baseline check_gates from tools/..."
            set +e
            python tools/check_gates.py \
              --config pulse_gates.yaml \
              --status status_baseline.json \
              --defer-policy fail
            rc=$?
            set -e
          elif [ -f scripts/check_gates.py ]; then
            echo "Running baseline check_gates from scripts/..."
            set +e
            python scripts/check_gates.py \
              --config pulse_gates.yaml \
              --status status_baseline.json \
              --defer-policy fail
            rc=$?
            set -e
          else
            echo "No checker found; keeping stub status_baseline.json"
            rc=0
          fi

          echo "rc=$rc" >> "$GITHUB_OUTPUT"
          if [ "$rc" -ne 0 ]; then
            echo "::warning::Baseline check_gates exited non-zero (rc=$rc)."
          fi

      - name: EPF shadow run (non-blocking) or stub
        id: epf
        shell: bash
        run: |
          set -euo pipefail

          # EPF shadow run starts from the same baseline input
          if [ -f status.json ]; then
            cp status.json status_epf.json
          else
            echo '{"experiments":{"epf":{}}}' > status_epf.json
          fi

          # If there is no EPF gate config, stay in stub mode
          if [ ! -f pulse_gates.yaml ]; then
            echo "::warning::pulse_gates.yaml not found; EPF shadow run will use stub decisions."
            echo "rc=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          rc=0
          if [ -f tools/check_gates.py ]; then
            echo "Running EPF shadow check_gates from tools/..."
            set +e
            python tools/check_gates.py \
              --config pulse_gates.yaml \
              --status status_epf.json \
              --epf-shadow \
              --seed 1737 \
              --defer-policy warn
            rc=$?
            set -e
          elif [ -f scripts/check_gates.py ]; then
            echo "Running EPF shadow check_gates from scripts/..."
            set +e
            python scripts/check_gates.py \
              --config pulse_gates.yaml \
              --status status_epf.json \
              --epf-shadow \
              --seed 1737 \
              --defer-policy warn
            rc=$?
            set -e
          else
            echo "No checker found; keeping stub status_epf.json"
            rc=0
          fi

          echo "rc=$rc" >> "$GITHUB_OUTPUT"
          if [ "$rc" -ne 0 ]; then
            echo "::warning::EPF check_gates exited non-zero (rc=$rc)."
          fi

      - name: Compare & summarize
        shell: bash
        env:
          DEPS_RC: ${{ steps.deps.outputs.rc }}
          RUNALL_RC: ${{ steps.prepare.outputs.runall_rc }}
          BASE_RC: ${{ steps.base.outputs.rc }}
          EPF_RC: ${{ steps.epf.outputs.rc }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, pathlib, os

          def load_json(path, default):
              try:
                  with open(path, "r", encoding="utf-8") as f:
                      return json.load(f)
              except Exception:
                  return default

          a = load_json("status_baseline.json", {"decisions": {}})
          b = load_json("status_epf.json", {"experiments": {"epf": {}}})

          da = a.get("decisions", {}) or {}
          db = (b.get("experiments", {}) or {}).get("epf", {}) or {}

          dec_epf = {}
          for k, v in db.items():
              if isinstance(v, dict):
                  dec = v.get("decision", v.get("status", v))
              else:
                  dec = v
              dec_epf[k] = dec

          total = len(da)
          diffs = []
          for k, v in da.items():
              dv = dec_epf.get(k, None)
              # IMPORTANT: dv may be False/0; treat that as a real value.
              if dv is not None and dv != v:
                  diffs.append((k, v, dv))

          deps_rc = os.environ.get("DEPS_RC", "")
          runall_rc = os.environ.get("RUNALL_RC", "")
          base_rc = os.environ.get("BASE_RC", "")
          epf_rc = os.environ.get("EPF_RC", "")

          summary = ""
          summary += f"Deps install rc: {deps_rc}\n"
          summary += f"run_all.py rc: {runall_rc}\n"
          summary += f"baseline check_gates rc: {base_rc}\n"
          summary += f"epf check_gates rc: {epf_rc}\n"
          summary += "\n"
          summary += f"Total baseline gates: {total}\n"
          summary += f"Changed (baseline->EPF): {len(diffs)}\n"

          for k, ba, ep in diffs[:20]:
              summary += f"- {k}: {ba} -> {ep}\n"

          pathlib.Path("epf_report.txt").write_text(summary, encoding="utf-8")
          print(summary)

          paradox = {
              "deps_rc": deps_rc,
              "runall_rc": runall_rc,
              "baseline_rc": base_rc,
              "epf_rc": epf_rc,
              "total_gates": total,
              "changed": len(diffs),
              "examples": [{"gate": k, "baseline": ba, "epf": ep} for k, ba, ep in diffs[:5]],
          }
          pathlib.Path("epf_paradox_summary.json").write_text(
              json.dumps(paradox, indent=2, ensure_ascii=False),
              encoding="utf-8"
          )
          PY

          {
            echo "### EPF Shadow Summary";
            echo '```';
            cat epf_report.txt;
            echo '```';
          } >> "$GITHUB_STEP_SUMMARY"

          if [ -f epf_paradox_summary.json ]; then
            changed="$(python - <<'PY'
          import json
          try:
              with open("epf_paradox_summary.json", "r", encoding="utf-8") as f:
                  data = json.load(f)
          except Exception:
              data = {}
          print(data.get("changed", 0))
          PY
            )"
            if [ "$changed" -gt 0 ] 2>/dev/null; then
              echo "⚠️ EPF shadow detected ${changed} gate(s) with different decisions than the baseline." >> "$GITHUB_STEP_SUMMARY"
            else
              echo "✅ EPF shadow run: no gate-level decision changes detected." >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: epf-ab-artifacts
          if-no-files-found: warn
          path: |
            status_baseline.json
            status_epf.json
            epf_report.txt
            epf_paradox_summary.json

