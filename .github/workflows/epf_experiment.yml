name: EPF experiment (shadow)

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
    paths:
      - "PULSE_safe_pack_v0/**"
      - "tools/**"
      - "scripts/**"
      - "pulse_gates.yaml"
      - ".github/workflows/epf_experiment.yml"

# Default least-privilege (job-level permissions below keep it explicit too)
permissions:
  contents: read

jobs:
  ab-run:
    concurrency:
      # Keep concurrency but avoid cross-branch cancellation by scoping to ref
      group: epf-shadow-${{ github.ref }}
      cancel-in-progress: true

    permissions:
      contents: read
      actions: read

    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.11"

      - name: Install deps (PULSE pack if available, else minimal)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          if [ -f PULSE_safe_pack_v0/requirements.txt ]; then
            echo "Installing PULSE_safe_pack_v0 requirements..."
            pip install -r PULSE_safe_pack_v0/requirements.txt
          else
            echo "No PULSE_safe_pack_v0/requirements.txt, installing minimal deps..."
            pip install numpy jsonschema || true
          fi

      - name: Prepare inputs from PULSE pack baseline (or stub)
        id: prepare
        shell: bash
        run: |
          set -euo pipefail
          if [ -f PULSE_safe_pack_v0/tools/run_all.py ]; then
            echo "Running PULSE_safe_pack_v0/tools/run_all.py to produce baseline status.json..."
            python PULSE_safe_pack_v0/tools/run_all.py || true
            if [ -f PULSE_safe_pack_v0/artifacts/status.json ]; then
              cp PULSE_safe_pack_v0/artifacts/status.json status.json
              echo "Using PULSE_safe_pack_v0/artifacts/status.json as baseline status.json"
            else
              echo "::warning::run_all.py completed but PULSE_safe_pack_v0/artifacts/status.json not found; using stub status.json"
              echo '{"metrics": {}}' > status.json
            fi
          else
            echo "::warning::PULSE_safe_pack_v0/tools/run_all.py not found; using stub status.json"
            echo '{"metrics": {}}' > status.json
          fi

      - name: Baseline (deterministic) or stub
        id: base
        shell: bash
        run: |
          set -euo pipefail

          # Start from status.json (real baseline or stub)
          if [ -f status.json ]; then
            cp status.json status_baseline.json
          else
            echo '{"decisions": {}}' > status_baseline.json
          fi

          # If there is no EPF gate config, stay in stub mode
          if [ ! -f pulse_gates.yaml ]; then
            echo "::warning::pulse_gates.yaml not found; baseline gate evaluation will run in stub mode."
            exit 0
          fi

          if [ -f tools/check_gates.py ]; then
            echo "Running baseline check_gates from tools/..."
            python tools/check_gates.py \
              --config pulse_gates.yaml \
              --status status_baseline.json \
              --defer-policy fail || true
          elif [ -f scripts/check_gates.py ]; then
            echo "Running baseline check_gates from scripts/..."
            python scripts/check_gates.py \
              --config pulse_gates.yaml \
              --status status_baseline.json \
              --defer-policy fail || true
          else
            echo '{"decisions": {}}' > status_baseline.json
            echo "No checker found; wrote stub status_baseline.json"
          fi

      - name: EPF shadow run (non-blocking) or stub
        id: epf
        shell: bash
        run: |
          set -euo pipefail

          # EPF shadow run starts from the same baseline input
          if [ -f status.json ]; then
            cp status.json status_epf.json
          else
            echo '{"experiments":{"epf":{}}}' > status_epf.json
          fi

          # If there is no EPF gate config, stay in stub mode
          if [ ! -f pulse_gates.yaml ]; then
            echo "::warning::pulse_gates.yaml not found; EPF shadow run will use stub decisions."
            exit 0
          fi

          if [ -f tools/check_gates.py ]; then
            echo "Running EPF shadow check_gates from tools/..."
            python tools/check_gates.py \
              --config pulse_gates.yaml \
              --status status_epf.json \
              --epf-shadow \
              --seed 1737 \
              --defer-policy warn || true
          elif [ -f scripts/check_gates.py ]; then
            echo "Running EPF shadow check_gates from scripts/..."
            python scripts/check_gates.py \
              --config pulse_gates.yaml \
              --status status_epf.json \
              --epf-shadow \
              --seed 1737 \
              --defer-policy warn || true
          else
            echo '{"experiments":{"epf":{}}}' > status_epf.json
            echo "No checker found; wrote stub status_epf.json"
          fi

      - name: Compare & summarize
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, pathlib

          def load_json(path, default):
              try:
                  with open(path, "r", encoding="utf-8") as f:
                      return json.load(f)
              except Exception:
                  return default

          a = load_json("status_baseline.json", {"decisions": {}})
          b = load_json("status_epf.json", {"experiments": {"epf": {}}})

          da = a.get("decisions", {}) or {}
          db = (b.get("experiments", {}) or {}).get("epf", {}) or {}

          dec_epf = {}
          for k, v in db.items():
              if isinstance(v, dict):
                  dec = v.get("decision", v.get("status", v))
              else:
                  dec = v
              dec_epf[k] = dec

          total = len(da)
          diffs = []
          for k, v in da.items():
              dv = dec_epf.get(k)
              if dv and dv != v:
                  diffs.append((k, v, dv))

          summary = f"Total gates: {total}\nChanged (baseline->EPF): {len(diffs)}\n"
          for k, ba, ep in diffs[:20]:
              summary += f"- {k}: {ba} -> {ep}\n"

          pathlib.Path("epf_report.txt").write_text(summary, encoding="utf-8")
          print(summary)

          paradox = {
              "total_gates": total,
              "changed": len(diffs),
              "examples": [
                  {"gate": k, "baseline": ba, "epf": ep}
                  for k, ba, ep in diffs[:5]
              ],
          }
          pathlib.Path("epf_paradox_summary.json").write_text(
              json.dumps(paradox, indent=2, ensure_ascii=False),
              encoding="utf-8"
          )
          PY

          {
            echo "### EPF Shadow Summary";
            echo '```';
            cat epf_report.txt;
            echo '```';
          } >> "$GITHUB_STEP_SUMMARY"

          if [ -f epf_paradox_summary.json ]; then
            changed=$(python - <<'PY'
          import json
          try:
              with open("epf_paradox_summary.json", "r", encoding="utf-8") as f:
                  data = json.load(f)
          except Exception:
              data = {}
          print(data.get("changed", 0))
          PY
            )
            if [ "$changed" -gt 0 ] 2>/dev/null; then
              {
                echo "";
                echo "⚠️ EPF shadow detected ${changed} gate(s) with different decisions than the baseline.";
              } >> "$GITHUB_STEP_SUMMARY"
            else
              {
                echo "";
                echo "✅ EPF shadow run: no gate-level decision changes detected.";
              } >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: epf-ab-artifacts
          if-no-files-found: warn
          path: |
            status_baseline.json
            status_epf.json
            epf_report.txt
            epf_paradox_summary.json

