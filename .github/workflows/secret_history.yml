name: Secret sweep (git history)
on:
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  trufflehog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history

      # TruffleHog scans the git history; continue-on-error keeps the job green for review
      - name: Run TruffleHog (history scan)
        id: th
        uses: trufflesecurity/trufflehog@v3
        with:
          scan: git
          path: .
        continue-on-error: true

      # Save raw findings (if any)
      - name: Save findings
        if: always()
        run: |
          mkdir -p findings
          # The action prints JSON lines to stdout; capture and save
          echo "${{ steps.th.outputs.result }}" > findings/trufflehog.json || true
      - name: Upload findings artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-findings
          path: findings/
