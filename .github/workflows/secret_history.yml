name: Secret sweep (git history)

on:
  workflow_dispatch: {}

permissions:
  contents: read
  actions: write

env:
  # Pinned image (linux/amd64) for reproducible, supply-chain-safe runs
  # Source: GHCR package page shows digests per arch
  TRUFFLEHOG_IMAGE: ghcr.io/trufflesecurity/trufflehog:3.92.4@sha256:61f9ac3434c6be5a1af4b42551b41f90d3ee0f9142fe63ec20793b494642f217
  TRUFFLEHOG_RESULTS: verified,unknown

jobs:
  trufflehog:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Run TruffleHog history scan (docker, non-blocking)
        id: scan
        shell: bash
        continue-on-error: true
        run: |
          set -euo pipefail
          mkdir -p findings

          echo "Using image: $TRUFFLEHOG_IMAGE"
          echo "Results mode: $TRUFFLEHOG_RESULTS"

          # IMPORTANT:
          # - We redirect stdout to a file to avoid leaking secrets into Actions logs.
          # - TruffleHog JSON output can include raw secret material; we sanitize later.
          docker run --rm \
            -v "$PWD:/workdir" \
            -w /workdir \
            "$TRUFFLEHOG_IMAGE" \
            git file:///workdir \
              --results="$TRUFFLEHOG_RESULTS" \
              --json \
              --fail \
              --quiet \
            > findings/trufflehog_raw.ndjson || true

      - name: Sanitize findings (remove secret material)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          python - <<'PY'
          import json
          from pathlib import Path

          raw = Path("findings/trufflehog_raw.ndjson")
          safe = Path("findings/trufflehog_findings_sanitized.ndjson")
          summary = Path("findings/trufflehog_summary.md")

          safe.parent.mkdir(parents=True, exist_ok=True)

          count_total = 0
          count_verified = 0
          examples = []

          def pick_git(obj: dict) -> dict:
              sm = obj.get("SourceMetadata") or {}
              data = sm.get("Data") or {}
              git = data.get("Git") or {}
              return {
                  "commit": git.get("commit"),
                  "file": git.get("file"),
                  "line": git.get("line"),
              }

          if raw.exists() and raw.stat().st_size > 0:
              with raw.open("r", encoding="utf-8") as f_in, safe.open("w", encoding="utf-8") as f_out:
                  for line in f_in:
                      line = line.strip()
                      if not line:
                          continue
                      try:
                          obj = json.loads(line)
                      except Exception:
                          # If any non-JSON sneaks into stdout, skip it.
                          continue

                      count_total += 1
                      if obj.get("Verified") is True:
                          count_verified += 1

                      git = pick_git(obj)

                      # Store ONLY safe triage fields (no Raw / Redacted / ExtraData).
                      item = {
                          "detector_name": obj.get("DetectorName"),
                          "detector_type": obj.get("DetectorType"),
                          "verified": obj.get("Verified"),
                          **git,
                      }
                      f_out.write(json.dumps(item, ensure_ascii=False) + "\n")

                      if len(examples) < 10:
                          examples.append(item)
          else:
              # Ensure artifact paths exist even when empty
              safe.write_text("", encoding="utf-8")

          # Delete raw output to avoid accidental artifact/log exposure
          try:
              raw.unlink()
          except FileNotFoundError:
              pass

          lines = []
          lines.append("# TruffleHog history scan (sanitized)")
          lines.append("")
          lines.append(f"- Findings: **{count_total}**")
          lines.append(f"- Verified findings: **{count_verified}**")
          lines.append("")

          if count_total == 0:
              lines.append("No findings detected.")
          else:
              lines.append("## Examples (first 10, sanitized)")
              lines.append("")
              for it in examples:
                  name = it.get("detector_name") or it.get("detector_type") or "unknown-detector"
                  verdict = "VERIFIED" if it.get("verified") else "unverified"
                  loc = f"{it.get('file')}:{it.get('line')}"
                  commit = it.get("commit")
                  lines.append(f"- {name}: {verdict} â€” {loc} @ {commit}")

          summary.write_text("\n".join(lines) + "\n", encoding="utf-8")
          print(f"Wrote {safe} and {summary}")
          PY

      - name: Workflow summary (sanitized)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ -f findings/trufflehog_summary.md ]; then
            cat findings/trufflehog_summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No TruffleHog summary produced." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload sanitized findings artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-history-findings
          if-no-files-found: warn
          path: |
            findings/trufflehog_findings_sanitized.ndjson
            findings/trufflehog_summary.md

