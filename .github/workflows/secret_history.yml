name: Secret sweep (git history)

on:
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: secret-history-${{ github.ref }}
  cancel-in-progress: true

env:
  # Pinned image digest for reproducible runs (amd64)
  TRUFFLEHOG_IMAGE: ghcr.io/trufflesecurity/trufflehog:3.92.4@sha256:61f9ac3434c6be5a1af4b42551b41f90d3ee0f9142fe63ec20793b494642f217
  TRUFFLEHOG_RESULTS: verified,unknown

jobs:
  trufflehog:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Run TruffleHog history scan (docker, non-blocking)
        id: scan
        shell: bash
        continue-on-error: true
        run: |
          set -euo pipefail
          mkdir -p findings

          RAW="findings/trufflehog_raw.ndjson"
          ERR="findings/trufflehog_stderr.log"
          EXIT="findings/trufflehog_exit_code.txt"

          rm -f "$RAW" "$ERR" "$EXIT" || true

          echo "Using image: $TRUFFLEHOG_IMAGE"
          echo "Results mode: $TRUFFLEHOG_RESULTS"

          # Capture exit code explicitly (do NOT mask with || true).
          set +e
          docker run --rm \
            -v "$PWD:/workdir" \
            -w /workdir \
            "$TRUFFLEHOG_IMAGE" \
            git file:///workdir \
              --results="$TRUFFLEHOG_RESULTS" \
              --json \
              --fail \
              --quiet \
              --no-update \
            > "$RAW" 2> "$ERR"
          rc=$?
          set -e

          echo "$rc" > "$EXIT"
          echo "exit_code=$rc" >> "$GITHUB_OUTPUT"

          if [ "$rc" -eq 0 ]; then
            echo "TruffleHog: clean."
            exit 0
          fi

          if [ "$rc" -eq 183 ]; then
            # Findings detected with --fail. Keep non-blocking, but visible via warning + summary.
            echo "::warning::TruffleHog: findings detected (exit 183 with --fail)."
            exit 0
          fi

          # Real scan failure: keep the step red (continue-on-error keeps the job running).
          echo "::warning::TruffleHog: scan error (exit $rc). See findings/trufflehog_stderr.log"
          exit "$rc"

      - name: Sanitize findings (remove secret material)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          python - <<'PY'
          import json
          from pathlib import Path

          raw = Path("findings/trufflehog_raw.ndjson")
          err = Path("findings/trufflehog_stderr.log")
          exit_path = Path("findings/trufflehog_exit_code.txt")

          safe = Path("findings/trufflehog_findings_sanitized.ndjson")
          summary = Path("findings/trufflehog_summary.md")

          safe.parent.mkdir(parents=True, exist_ok=True)

          try:
              rc = int(exit_path.read_text(encoding="utf-8").strip())
          except Exception:
              rc = 0

          total = 0
          verified = 0
          examples = []

          def pick_git(obj: dict) -> dict:
              sm = obj.get("SourceMetadata") or {}
              data = sm.get("Data") or {}
              git = data.get("Git") or {}
              return {
                  "commit": git.get("commit"),
                  "file": git.get("file"),
                  "line": git.get("line"),
              }

          if raw.exists() and raw.stat().st_size > 0:
              with raw.open("r", encoding="utf-8") as f_in, safe.open("w", encoding="utf-8") as f_out:
                  for line in f_in:
                      line = line.strip()
                      if not line:
                          continue
                      try:
                          obj = json.loads(line)
                      except Exception:
                          continue

                      total += 1
                      if obj.get("Verified") is True:
                          verified += 1

                      git = pick_git(obj)

                      item = {
                          "detector_name": obj.get("DetectorName"),
                          "detector_type": obj.get("DetectorType"),
                          "verified": obj.get("Verified"),
                          **git,
                      }
                      f_out.write(json.dumps(item, ensure_ascii=False) + "\n")

                      if len(examples) < 10:
                          examples.append(item)
          else:
              safe.write_text("", encoding="utf-8")

          # Always delete raw output to avoid leaving any secret material on runner
          try:
              raw.unlink()
          except FileNotFoundError:
              pass

          lines = []
          lines.append("## TruffleHog history scan (sanitized)")
          lines.append("")
          lines.append(f"- Exit code: `{rc}` (0=clean, 183=findings with --fail, other=scan error)")
          lines.append(f"- Findings (sanitized): **{total}** (verified: {verified})")
          lines.append("")

          if rc not in (0, 183):
              lines.append("⚠️ Scan error detected — this is not a clean scan.")
              if err.exists() and err.stat().st_size > 0:
                  lines.append("")
                  lines.append("### Error excerpt (stderr, first 80 lines)")
                  lines.append("")
                  lines.append("```")
                  excerpt = err.read_text(encoding="utf-8", errors="replace").splitlines()[:80]
                  lines.extend(excerpt)
                  lines.append("```")
          else:
              if total == 0:
                  lines.append("No findings detected (or no JSON output produced).")
              else:
                  lines.append("### Examples (first 10, sanitized)")
                  lines.append("")
                  for it in examples:
                      name = it.get("detector_name") or it.get("detector_type") or "unknown-detector"
                      verdict = "VERIFIED" if it.get("verified") else "unverified"
                      loc = f"{it.get('file')}:{it.get('line')}"
                      commit = it.get("commit")
                      lines.append(f"- {name}: {verdict} — {loc} @ {commit}")

          summary.write_text("\n".join(lines) + "\n", encoding="utf-8")
          print("Wrote:", safe, summary)
          PY

      - name: Workflow summary (sanitized)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ -f findings/trufflehog_summary.md ]; then
            cat findings/trufflehog_summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No TruffleHog summary produced." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload findings artifact (sanitized)
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: trufflehog-history-findings
          if-no-files-found: warn
          path: |
            findings/trufflehog_findings_sanitized.ndjson
            findings/trufflehog_summary.md
            findings/trufflehog_exit_code.txt
            findings/trufflehog_stderr.log

