name: repo-hygiene

on:
  pull_request:
  push:
    branches: ["main"]

jobs:
  case_collision_guardrail:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Repo hygiene: forbid case-insensitive path collisions
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import sys
          from collections import defaultdict
          import subprocess

          files = subprocess.check_output(["git", "ls-files"], text=True).splitlines()
          m = defaultdict(list)
          for f in files:
              m[f.lower()].append(f)

          collisions = {k: v for k, v in m.items() if len(v) > 1}
          if collisions:
              print("ERROR: case-insensitive path collisions detected:")
              for _, v in sorted(collisions.items()):
                  print(" - " + "  |  ".join(v))
              sys.exit(1)

          print("OK: no case-insensitive collisions.")
          PY
