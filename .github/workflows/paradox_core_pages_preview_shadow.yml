name: Paradox Core Pages preview mount (shadow)

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  paradox_core_pages_preview_shadow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.11"

      - name: Locate case study transitions dir (fail-closed)
        shell: bash
        run: |
          set -euo pipefail
          CASE_DIR="docs/examples/transitions_case_study_v0"
          test -d "$CASE_DIR" || { echo "Missing case study dir: $CASE_DIR"; exit 1; }

          # Priority order (deterministic):
          # 1) explicit transitions/ subdir
          # 2) explicit transitions_gate_metric_tension_v0/ subdir
          # 3) CASE_DIR itself if it contains pulse_*_drift_v0* files
          # 4) otherwise, deterministically pick the first transitions* dir (sorted)
          if [ -d "$CASE_DIR/transitions" ]; then
            TRANSITIONS_DIR="$CASE_DIR/transitions"
          elif [ -d "$CASE_DIR/transitions_gate_metric_tension_v0" ]; then
            TRANSITIONS_DIR="$CASE_DIR/transitions_gate_metric_tension_v0"
          elif ls "$CASE_DIR"/pulse_*_drift_v0* >/dev/null 2>&1; then
            TRANSITIONS_DIR="$CASE_DIR"
          else
            TRANSITIONS_DIR="$(find "$CASE_DIR" -maxdepth 2 -type d -name 'transitions*' | sort | head -n 1 || true)"
          fi

          test -n "${TRANSITIONS_DIR:-}" || { echo "No transitions dir found under: $CASE_DIR"; exit 1; }
          test -d "$TRANSITIONS_DIR" || { echo "Transitions dir not a directory: $TRANSITIONS_DIR"; exit 1; }

          echo "TRANSITIONS_DIR=$TRANSITIONS_DIR" >> "$GITHUB_ENV"
          echo "Using transitions dir: $TRANSITIONS_DIR"

      - name: Build paradox_field_v0 + edges (case study)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf out
          mkdir -p out

          python scripts/paradox_field_adapter_v0.py \
            --transitions-dir "$TRANSITIONS_DIR" \
            --out out/paradox_field_v0.json

          python scripts/check_paradox_field_v0_contract.py \
            --in out/paradox_field_v0.json

          python scripts/export_paradox_edges_v0.py \
            --in out/paradox_field_v0.json \
            --out out/paradox_edges_v0.jsonl

          python scripts/check_paradox_edges_v0_contract.py \
            --in out/paradox_edges_v0.jsonl \
            --atoms out/paradox_field_v0.json

      - name: Build Paradox Core reviewer bundle (case study)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf out/paradox_core_bundle_case_study_v0

          python scripts/paradox_core_reviewer_bundle_v0.py \
            --field out/paradox_field_v0.json \
            --edges out/paradox_edges_v0.jsonl \
            --out-dir out/paradox_core_bundle_case_study_v0 \
            --k 12 \
            --metric severity

      - name: Mount bundle into Pages-like site preview (fail-closed)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf out/site_preview_v0
          mkdir -p out/site_preview_v0

          # Minimal deterministic root index for the preview bundle.
          cat > out/site_preview_v0/index.html << 'EOF'
          <!doctype html>
          <meta charset="utf-8">
          <title>PULSE Pages preview (shadow)</title>
          <h1>PULSE Pages preview (shadow)</h1>
          <ul>
            <li><a href="paradox/core/v0/">Paradox Core v0</a></li>
          </ul>
          EOF

          python scripts/pages_publish_paradox_core_bundle_v0.py \
            --bundle-dir out/paradox_core_bundle_case_study_v0 \
            --site-dir out/site_preview_v0 \
            --mount paradox/core/v0

      - name: Step summary
        shell: bash
        run: |
          set -euo pipefail
          echo "## Paradox Core Pages preview (shadow)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- transitions_dir: \`$TRANSITIONS_DIR\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- field: \`out/paradox_field_v0.json\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- edges: \`out/paradox_edges_v0.jsonl\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- bundle: \`out/paradox_core_bundle_case_study_v0\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- site preview: \`out/site_preview_v0\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Site preview tree (top)" >> "$GITHUB_STEP_SUMMARY"
          find out/site_preview_v0 -maxdepth 4 -type f | sort | sed 's/^/    /' >> "$GITHUB_STEP_SUMMARY"

      - name: Upload artifact (Pages preview)
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: paradox-core-pages-preview-v0
          path: out/site_preview_v0
          if-no-files-found: error
