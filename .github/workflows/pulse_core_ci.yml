name: PULSE Core CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  pull_request:
    branches: [ main ]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Least privilege: this workflow does not need to write back to the repo.
permissions:
  contents: read

jobs:
  pulse-core:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Locate PULSE pack
        shell: bash
        run: |
          set -euo pipefail
          ROOT="$GITHUB_WORKSPACE"

          if [ -d "$ROOT/PULSE_safe_pack_v0" ]; then
            echo "PACK_DIR=$ROOT/PULSE_safe_pack_v0" >> "$GITHUB_ENV"
          elif [ -f "$ROOT/PULSE_safe_pack_v0.zip" ]; then
            unzip -q -o "$ROOT/PULSE_safe_pack_v0.zip"
            echo "PACK_DIR=$ROOT/PULSE_safe_pack_v0" >> "$GITHUB_ENV"
          else
            RUN_ALL=$(find "$ROOT" -type f -name run_all.py -path "*/PULSE_safe_pack_v0/*" | head -n1 || true)
            if [ -z "$RUN_ALL" ]; then
              echo "::error::PULSE_safe_pack_v0 not found (expected folder or zip in repo root)."
              exit 1
            fi
            echo "PACK_DIR=$(dirname "$(dirname "$RUN_ALL")")" >> "$GITHUB_ENV"
          fi

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.11"

      - name: Install minimal Python deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: YAML duplicate-key guard (fail-closed)
        shell: bash
        run: |
          set -euo pipefail
          python tools/check_yaml_unique_keys.py \
            pulse_gate_registry_v0.yml \
            pulse_gate_policy_v0.yml

      - name: Run PULSE Core pack
        shell: bash
        run: |
          set -euo pipefail
          python "${PACK_DIR}/tools/run_all.py"

      - name: Gate registry sync check
        shell: bash
        run: |
          set -euo pipefail
          python tools/check_gate_registry_sync.py \
            --status "${PACK_DIR}/artifacts/status.json" \
            --registry pulse_gate_registry_v0.yml \
            --emit-stubs

      - name: Show gates snapshot
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          STATUS="${PACK_DIR}/artifacts/status.json"
          echo "----- status.json (gates) -----"
          if [ -f "$STATUS" ]; then
            if command -v jq >/dev/null 2>&1; then
              jq '.gates' "$STATUS" || cat "$STATUS"
            else
              cat "$STATUS"
            fi
          else
            echo "::warning::No status.json produced at $STATUS"
          fi
          echo "--------------------------------"

      - name: Enforce Core gates (fail-closed)
        shell: bash
        run: |
          set -euo pipefail

          STATUS="${PACK_DIR}/artifacts/status.json"
          if [ ! -f "$STATUS" ]; then
            echo "::error::Missing status.json at $STATUS"
            exit 1
          fi

          # Core profile: minimal deterministic gates for first-time adopters
          REQ=(
            pass_controls_refusal
            pass_controls_sanit
            sanitization_effective
            q1_grounded_ok
            q4_slo_ok
          )

          python "${PACK_DIR}/tools/check_gates.py" \
            --status "$STATUS" \
            --require "${REQ[@]}"

      - name: Export JUnit & SARIF
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p reports

          STATUS="${PACK_DIR}/artifacts/status.json"
          if [ ! -f "$STATUS" ]; then
            echo "::warning::No status.json found; skipping JUnit/SARIF export."
            exit 0
          fi

          # PULSE converters expect status.json in cwd
          cp "$STATUS" status.json

          python "${PACK_DIR}/tools/status_to_junit.py" || echo "JUnit export failed (optional)"
          python "${PACK_DIR}/tools/status_to_sarif.py" || echo "SARIF export failed (optional)"

          if [ -f junit.xml ]; then
            mv junit.xml reports/junit.xml
          fi
          if [ -f sarif.json ]; then
            mv sarif.json reports/sarif.json
          fi

      - name: Upload PULSE Core artefacts
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: pulse-core-report
          if-no-files-found: warn
          path: |
            ${{ env.PACK_DIR }}/artifacts/**
            reports/junit.xml
            reports/sarif.json
