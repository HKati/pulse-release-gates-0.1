      - name: Compute refusal-delta (policy-config)
        shell: bash
        run: |
          set -euo pipefail
          RD="${{ env.PACK_DIR }}/tools/refusal_delta_calc.py"
          if [ ! -f "$RD" ]; then
            RD="$(find "${{ env.PACK_DIR }}" -type f -name 'refusal_delta_calc.py' | head -n1 || true)"
          fi
          if [ -z "$RD" ] || [ ! -f "$RD" ]; then
            echo "::error::refusal_delta_calc.py not found under ${{ env.PACK_DIR }}"
            exit 1
          fi
          REAL="${{ env.PACK_DIR }}/examples/refusal_pairs.jsonl"
          if [ -f "$REAL" ]; then
            PAIRS="$REAL"
            echo "Using REAL pairs: $PAIRS"
          else
            PAIRS="${{ env.PACK_DIR }}/examples/refusal_pairs_sample.jsonl"
            echo "Using SAMPLE pairs: $PAIRS"
          fi
          POL="${{ env.PACK_DIR }}/profiles/pulse_policy.yaml"
          if [ ! -f "$POL" ]; then
            echo "::warning::pulse_policy.yaml not found; using baked defaults"
          fi
          python "$RD" \
            --pairs "$PAIRS" \
            --out "${{ env.PACK_DIR }}/artifacts/refusal_delta_summary.json" \
            --policy_config "$POL"

      - name: Show refusal-delta summary
        run: |
          echo "----- refusal_delta_summary.json -----"
          cat "${{ env.PACK_DIR }}/artifacts/refusal_delta_summary.json" || true
          echo "-------------------------------------"
