name: PULSE CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  pulse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Locate PULSE pack
        shell: bash
        run: |
          set -euo pipefail
          ROOT="$GITHUB_WORKSPACE"
          if [ -f "$ROOT/PULSE_safe_pack_v0/tools/run_all.py" ]; then
            echo "PACK_DIR=$ROOT/PULSE_safe_pack_v0" >> "$GITHUB_ENV"
          elif [ -f "$ROOT/PULSE_safe_pack_v0.zip" ]; then
            unzip -q -o "$ROOT/PULSE_safe_pack_v0.zip"
            echo "PACK_DIR=$ROOT/PULSE_safe_pack_v0" >> "$GITHUB_ENV"
          else
            RUN_ALL=$(find "$ROOT" -type f -name run_all.py -path "*/PULSE_safe_pack_v0/*" | head -n1 || true)
            if [ -z "$RUN_ALL" ]; then
              echo "::error::PULSE pack not found in repo root."
              exit 1
            fi
            echo "PACK_DIR=$(dirname "$(dirname "$RUN_ALL")")" >> "$GITHUB_ENV"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python deps (PyYAML)
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Install decision trace validator deps
        run: |
          python -m pip install jsonschema

      - name: Ensure directories
        shell: bash
        run: |
          mkdir -p "${{ env.PACK_DIR }}/artifacts/external"
          mkdir -p "${{ env.PACK_DIR }}/examples"

      - name: Hotfix update_badges f-string
        shell: bash
        run: |
          BADGE="$(find "${{ env.PACK_DIR }}" -type f -path '*/tools/ci/update_badges.py' | head -n1 || true)"
          if [ -n "$BADGE" ]; then
            sed -i 's/return ff"""/return f"""/g' "$BADGE" || true
          fi

      - name: Run PULSE
        shell: bash
        run: |
          python "${{ env.PACK_DIR }}/tools/run_all.py"

      - name: Compute refusal-delta (policy-config)
        shell: bash
        run: |
          set -euo pipefail
          RD="${{ env.PACK_DIR }}/tools/refusal_delta_calc.py"
          if [ ! -f "$RD" ]; then
            RD="$(find "${{ env.PACK_DIR }}" -type f -name 'refusal_delta_calc.py' | head -n1 || true)"
          fi
          if [ -z "$RD" ] || [ ! -f "$RD" ]; then
            echo "::error::refusal_delta_calc.py not found under ${{ env.PACK_DIR }}"
            exit 1
          fi

          REAL="${{ env.PACK_DIR }}/examples/refusal_pairs.jsonl"
          if [ -f "$REAL" ]; then
            PAIRS="$REAL"
            echo "Using REAL pairs: $PAIRS"
          else
            PAIRS="${{ env.PACK_DIR }}/examples/refusal_pairs_sample.jsonl"
            if [ ! -f "$PAIRS" ]; then
              printf '%s\n' '{"pair_id":"ex1","plain_refusal":true,"tool_refusal":false}' > "$PAIRS"
              printf '%s\n' '{"pair_id":"ex2","plain_refusal":true,"tool_refusal":true}' >> "$PAIRS"
              printf '%s\n' '{"pair_id":"ex3","plain_refusal":false,"tool_refusal":false}' >> "$PAIRS"
              printf '%s\n' '{"pair_id":"ex4","plain_refusal":true,"tool_refusal":false}' >> "$PAIRS"
            fi
            echo "Using SAMPLE pairs: $PAIRS"
          fi

          POL="${{ env.PACK_DIR }}/profiles/pulse_policy.yaml"
          python "$RD" \
            --pairs "$PAIRS" \
            --out "${{ env.PACK_DIR }}/artifacts/refusal_delta_summary.json" \
            --policy_config "$POL"

      - name: Show refusal-delta summary
        shell: bash
        run: |
          echo "----- refusal_delta_summary.json -----"
          cat "${{ env.PACK_DIR }}/artifacts/refusal_delta_summary.json" || true
          echo "-------------------------------------"

      - name: Augment status (external + top-level flags)
        shell: bash
        run: |
          python "${{ env.PACK_DIR }}/tools/augment_status.py" \
            --status "${{ env.PACK_DIR }}/artifacts/status.json" \
            --thresholds "${{ env.PACK_DIR }}/profiles/external_thresholds.yaml" \
            --external_dir "${{ env.PACK_DIR }}/artifacts/external"

      - name: Show gates snapshot
        shell: bash
        run: |
          echo "----- status.json (gates) -----"
          jq '.gates' "${{ env.PACK_DIR }}/artifacts/status.json" || cat "${{ env.PACK_DIR }}/artifacts/status.json" || true
          echo "--------------------------------"

      - name: Validate decision trace schema (shadow)
        shell: bash
        continue-on-error: true
        run: |
          python "${{ env.PACK_DIR }}/tools/validate_decision_trace_v0.py" || echo "decision trace validation failed (shadow)"

      - name: Enforce (Fail-Closed)
        shell: bash
        run: |
          set -euo pipefail
          REQ=(
            pass_controls_refusal effect_present
            psf_monotonicity_ok psf_mono_shift_resilient
            pass_controls_comm psf_commutativity_ok psf_comm_shift_resilient
            pass_controls_sanit sanitization_effective sanit_shift_resilient
            psf_action_monotonicity_ok psf_idempotence_ok psf_path_independence_ok psf_pii_monotonicity_ok
            q1_grounded_ok q2_consistency_ok q3_fairness_ok q4_slo_ok
            external_all_pass
          )
          if [ -f "${{ env.PACK_DIR }}/examples/refusal_pairs.jsonl" ]; then
            REQ+=(refusal_delta_pass)
            echo "Requiring extra gate: refusal_delta_pass"
          else
            echo "No real pairs; refusal_delta_pass not required"
          fi

          python "${{ env.PACK_DIR }}/tools/check_gates.py" \
            --status "${{ env.PACK_DIR }}/artifacts/status.json" \
            --required "${REQ[@]}"

      - name: Update badges
        if: always()
        shell: bash
        run: |
          mkdir -p badges
          python "${{ env.PACK_DIR }}/tools/ci/update_badges.py" \
            --status "${{ env.PACK_DIR }}/artifacts/status.json" \
            --assets badges \
            --out badges

      - name: Commit badge changes [skip ci]
        if: always()
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add badges/*.svg || true
          if git diff --cached --quiet; then
            echo "No badge changes."
          else
            git commit -m "chore: update badges [skip ci]"
            git push
          fi

      - name: Export JUnit & SARIF
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p reports

          # Make status.json available in the working directory for the tools
          cp "${{ env.PACK_DIR }}/artifacts/status.json" status.json

          # Run converters; they expect status.json in the current directory
          python "${{ env.PACK_DIR }}/tools/status_to_junit.py"
          python "${{ env.PACK_DIR }}/tools/status_to_sarif.py"

          # If outputs were written to the current dir, move them under reports/
          if [ -f junit.xml ]; then
            mv junit.xml reports/junit.xml
          fi
          if [ -f sarif.json ]; then
            mv sarif.json reports/sarif.json
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pulse-report
          path: |
            ${{ env.PACK_DIR }}/artifacts/**
            badges/*.svg
            reports/junit.xml
            reports/sarif.json

  tools-tests:
    name: Tools smoke tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run exporter smoke tests
        run: |
          python - <<'PY'
          import pathlib, subprocess, os, sys
          root = pathlib.Path('.').resolve()
          (root / 'tests' / 'out').mkdir(parents=True, exist_ok=True)
          subprocess.check_call([sys.executable, 'tests/test_exporters.py'])
          print('Exporter smoke tests OK')
          PY
