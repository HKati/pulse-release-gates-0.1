name: PULSE CI (run + enforce + badges + artifacts + PR comment)

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  pulse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run PULSE
        run: |
          python PULSE_safe_pack_v0/tools/run_all.py

      - name: Enforce (Fail-Closed)
        run: |
          python PULSE_safe_pack_v0/tools/check_gates.py --status PULSE_safe_pack_v0/artifacts/status.json --require \
            pass_controls_refusal effect_present psf_monotonicity_ok psf_mono_shift_resilient \
            pass_controls_comm psf_commutativity_ok psf_comm_shift_resilient \
            pass_controls_sanit sanitization_effective sanit_shift_resilient \
            psf_action_monotonicity_ok psf_idempotence_ok psf_path_independence_ok psf_pii_monotonicity_ok \
            q1_grounded_ok q2_consistency_ok q3_fairness_ok q4_slo_ok

      - name: Augment status with external detectors
        run: |
          python -m pip install pyyaml
          python PULSE_safe_pack_v0/tools/augment_status.py \
            --status PULSE_safe_pack_v0/artifacts/status.json \
            --thresholds PULSE_safe_pack_v0/profiles/external_thresholds.yaml \
            --external_dir PULSE_safe_pack_v0/artifacts/external

      - name: Update badges (PASS/FAIL, RDSI, Q-Ledger)
        if: always()
        run: |
          # A repód gyökerében lévő 'badges/' mappa statikus ikonjait használjuk forrásnak
          python PULSE_safe_pack_v0/tools/ci/update_badges.py \
            --status PULSE_safe_pack_v0/artifacts/status.json \
            --assets badges \
            --out badges

      - name: Commit badge changes to repo (with [skip ci])
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add badges/*.svg || true
          if git diff --cached --quiet; then
            echo "No badge changes."
          else
            git commit -m "chore: update PULSE badges [skip ci]"
            git push
          fi

      - name: Upload PULSE artifacts (report + status + badges)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pulse-report
          path: |
            PULSE_safe_pack_v0/artifacts/**
            badges/*.svg

      - name: Generate Q-Ledger PR comment (only on PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          python PULSE_safe_pack_v0/tools/ci/pr_comment_qledger.py \
            --status PULSE_safe_pack_v0/artifacts/status.json \
            --out q_ledger_comment.md

      - name: Post/Update PR comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: q_ledger_comment.md
