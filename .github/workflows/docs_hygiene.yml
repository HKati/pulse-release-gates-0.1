name: docs-hygiene

on:
  pull_request:
    paths:
      - "README.md"
      - "CITATION.cff"
      - ".github/workflows/*.yml"

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: "Repo hygiene: forbid case-insensitive path collisions"
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import sys
          from collections import defaultdict
          import subprocess

          files = subprocess.check_output(["git", "ls-files"], text=True).splitlines()
          m = defaultdict(list)
          for f in files:
              m[f.lower()].append(f)

          collisions = {k: v for k, v in m.items() if len(v) > 1}
          if collisions:
              print("ERROR: case-insensitive path collisions detected:")
              for _, v in sorted(collisions.items()):
                  print(" - " + "  |  ".join(v))
              sys.exit(1)

          print("OK: no case-insensitive collisions.")
          PY

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.11"

      - name: Install cffconvert
        run: pip install cffconvert

      - name: Validate CITATION.cff â†’ BibTeX
        run: cffconvert -i CITATION.cff -f bibtex > /dev/null

      - name: Check DOIs present and consistent (README & CFF)
        shell: bash
        run: |
          for f in README.md CITATION.cff; do
            grep -q "10.5281/zenodo.17373002" "$f" || { echo "Missing RELEASE DOI in $f"; exit 1; }
            grep -q "10.5281/zenodo.17214908" "$f" || { echo "Missing CONCEPT DOI in $f"; exit 1; }
          done

      - name: Check README code fences are balanced
        shell: bash
        run: |
          n=$(grep -o '```' README.md | wc -l || true)
          if [ $((n % 2)) -ne 0 ]; then
            echo "Unbalanced code fences in README.md"; exit 1
          fi

      - name: Check emails are clickable (mailto:)  # SAFE MODE (warning only)
        shell: bash
        run: |
          if ! grep -q "mailto:" README.md; then
            echo "::warning::No 'mailto:' links in README.md"
          fi

