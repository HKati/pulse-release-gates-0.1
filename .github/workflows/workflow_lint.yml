name: workflow-lint

on:
  pull_request:
    paths:
      - ".github/workflows/*.yml"
      - ".github/workflows/*.yaml"
  push:
    branches: ["main"]
    paths:
      - ".github/workflows/*.yml"
      - ".github/workflows/*.yaml"

permissions:
  contents: read

jobs:
  lint_workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
        with:
          python-version: "3.11"

      - name: Install PyYAML (for workflow parsing)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --disable-pip-version-check "pyyaml==6.0.2"

      - name: Validate workflow YAML (parse + guardrails)
        shell: bash
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import re
          import sys
          import pathlib

          import yaml

          root = pathlib.Path(".github/workflows")
          files = sorted(list(root.glob("*.yml")) + list(root.glob("*.yaml")))

          if not files:
              print("::warning::No workflow files found under .github/workflows/")
              sys.exit(0)

          # Heuristic for the known footgun.
          # IMPORTANT: we only use this as a hint when YAML parsing fails
          # (so we never false-positive on block scalars like `run: |`).
          colon_name_line_re = re.compile(r'^\s*-\s*name:\s+[^"\'].*:\s+.*$')

          ok = True

          for f in files:
              text = f.read_text(encoding="utf-8", errors="replace")
              lines = text.splitlines()

              try:
                  obj = yaml.safe_load(text)
              except yaml.YAMLError as e:
                  line = None
                  col = None
                  mark = getattr(e, "problem_mark", None)
                  if mark is not None:
                      line = mark.line + 1
                      col = mark.column + 1

                  loc = f",line={line},col={col}" if line is not None and col is not None else ""
                  msg = str(e).replace("\n", " | ")
                  print(f"::error file={f}{loc}::YAML parse error: {msg}")

                  # Provide an actionable hint if the failing line (or nearby) looks like the unquoted-colon step-name issue.
                  if line is not None:
                      for ln in (line - 1, line, line + 1):
                          if 1 <= ln <= len(lines):
                              s = lines[ln - 1]
                              if colon_name_line_re.search(s):
                                  print(
                                      f"::error file={f},line={ln}::Likely unquoted ':' in a step name. "
                                      f"Quote the value of '- name: ...'."
                                  )
                                  break

                  ok = False
                  continue

              if obj is None:
                  print(f"::error file={f}::Workflow YAML is empty (safe_load returned None).")
                  ok = False
                  continue

              if not isinstance(obj, dict):
                  print(f"::error file={f}::Workflow YAML must be a mapping at top-level (got {type(obj).__name__}).")
                  ok = False
                  continue

              # Minimal sanity: expect at least one of the canonical keys
              if not any(k in obj for k in ("on", "name", "jobs")):
                  print(f"::warning file={f}::Top-level keys look unusual (missing 'on'/'jobs').")

          if not ok:
              sys.exit(1)

          print(f"OK: validated {len(files)} workflow file(s).")
          PY

